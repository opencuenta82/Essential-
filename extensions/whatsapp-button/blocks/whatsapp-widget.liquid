{% comment %} Leer configuraci√≥n SOLO desde metafields (sin valores por defecto) {% endcomment %}
{% assign phone_number = shop.metafields.whatsapp_widget.phone_number %}
{% assign message = shop.metafields.whatsapp_widget.message %}
{% assign button_color = shop.metafields.whatsapp_widget.button_color %}
{% assign position = shop.metafields.whatsapp_widget.position %}
{% assign icon = shop.metafields.whatsapp_widget.icon %}

{% comment %} Solo mostrar si est√° habilitado Y si hay datos del formulario {% endcomment %}
{% if block.settings.enable_widget and phone_number != blank and message != blank %}

{% comment %} Debug: Verificar datos del formulario {% endcomment %}
<script>
  console.log('=== WHATSAPP WIDGET DEBUG ===');
  console.log('Metafields disponibles:', {{ shop.metafields.whatsapp_widget | json }});
  console.log('Configuraci√≥n desde formulario:', {
    phone: '{{ phone_number }}',
    message: '{{ message }}',
    color: '{{ button_color }}',
    position: '{{ position }}',
    icon: '{{ icon }}',
    source: 'formulario √∫nicamente',
    timestamp: '{{ "now" | date: "%Y-%m-%d %H:%M:%S" }}'
  });
  
  // Verificar si los metafields est√°n configurados
  {% if shop.metafields.whatsapp_widget.phone_number %}
    console.log('‚úÖ Formulario configurado - phone_number:', '{{ shop.metafields.whatsapp_widget.phone_number }}');
  {% else %}
    console.log('‚ùå Formulario NO configurado - phone_number faltante');
  {% endif %}
  
  {% if shop.metafields.whatsapp_widget.message %}
    console.log('‚úÖ Formulario configurado - message:', '{{ shop.metafields.whatsapp_widget.message }}');
  {% else %}
    console.log('‚ùå Formulario NO configurado - message faltante');
  {% endif %}
  
  {% if shop.metafields.whatsapp_widget.button_color %}
    console.log('‚úÖ Formulario configurado - button_color:', '{{ shop.metafields.whatsapp_widget.button_color }}');
  {% else %}
    console.log('‚ùå Formulario NO configurado - button_color faltante');
  {% endif %}
  
  {% if shop.metafields.whatsapp_widget.position %}
    console.log('‚úÖ Formulario configurado - position:', '{{ shop.metafields.whatsapp_widget.position }}');
  {% else %}
    console.log('‚ùå Formulario NO configurado - position faltante');
  {% endif %}
  
  {% if shop.metafields.whatsapp_widget.icon %}
    console.log('‚úÖ Formulario configurado - icon:', '{{ shop.metafields.whatsapp_widget.icon }}');
  {% else %}
    console.log('‚ùå Formulario NO configurado - icon faltante');
  {% endif %}
</script>

{% comment %} Widget de WhatsApp usando SOLO la configuraci√≥n del formulario {% endcomment %}
<div id="whatsapp-widget-{{ block.id }}" style="
  position: fixed;
  {% case position %}
    {% when 'top-left' %}
      top: 20px;
      left: 20px;
    {% when 'top-right' %}
      top: 20px;
      right: 20px;
    {% when 'bottom-left' %}
      bottom: 20px;
      left: 20px;
    {% when 'bottom-right' %}
      bottom: 20px;
      right: 20px;
    {% else %}
      bottom: 20px;
      right: 20px;
  {% endcase %}
  z-index: 9999;
  background-color: {{ button_color }};
  border-radius: {{ block.settings.border_radius | default: 50 }}px;
  padding: 15px 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  cursor: pointer;
  transition: transform 0.3s ease;
  font-size: {{ block.settings.font_size | default: 14 }}px;
  color: white;
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 10px;
  opacity: {{ block.settings.opacity | default: 100 | divided_by: 100.0 }};
" onclick="openWhatsApp{{ block.id }}()">
  <span style="font-size: {{ block.settings.font_size | default: 14 | plus: 10 }}px;">{{ icon }}</span>
  {% if block.settings.show_text %}
    <span style="font-weight: bold;">{{ block.settings.button_text | default: 'WhatsApp' }}</span>
  {% endif %}
</div>

<script>
function openWhatsApp{{ block.id }}() {
  const phone = '{{ phone_number }}';
  const message = encodeURIComponent('{{ message | escape }}');
  
  // ‚úÖ URL CORREGIDA: Usar wa.me en lugar de api.whatsapp.com
  const url = `https://wa.me/${phone}?text=${message}`;
  
  console.log('üöÄ Abriendo WhatsApp con datos del formulario:', {
    phone: phone,
    message: '{{ message | escape }}',
    url: url,
    urlType: 'wa.me - CORRECTO ‚úÖ'
  });
  
  // Verificar que la URL sea correcta antes de abrir
  if (url.includes('wa.me')) {
    console.log('‚úÖ URL correcta detectada: wa.me');
  } else {
    console.error('‚ùå URL incorrecta detectada');
  }
  
  {% if block.settings.open_in_new_tab %}
    window.open(url, '_blank');
  {% else %}
    window.location.href = url;
  {% endif %}
}

// Hover effect con mejor rendimiento
const hoverWidget{{ block.id }} = document.getElementById('whatsapp-widget-{{ block.id }}');
if (hoverWidget{{ block.id }}) {
  hoverWidget{{ block.id }}.addEventListener('mouseenter', function() {
    this.style.transform = 'scale({{ block.settings.hover_scale | default: 110 | divided_by: 100.0 }})';
  });

  hoverWidget{{ block.id }}.addEventListener('mouseleave', function() {
    this.style.transform = 'scale(1)';
  });
}

// Animaci√≥n de entrada si est√° habilitada
{% if block.settings.entrance_animation %}
document.addEventListener('DOMContentLoaded', function() {
  const widget = document.getElementById('whatsapp-widget-{{ block.id }}');
  if (widget) {
    widget.style.opacity = '0';
    widget.style.transform = 'scale(0.5)';
    
    setTimeout(() => {
      widget.style.transition = 'all 0.5s ease';
      widget.style.opacity = '{{ block.settings.opacity | default: 100 | divided_by: 100.0 }}';
      widget.style.transform = 'scale(1)';
    }, {{ block.settings.entrance_delay | default: 1000 }});
  }
});
{% endif %}

// Limpiar cache forzadamente (solo en desarrollo)
{% if request.design_mode %}
  console.log('üîÑ Modo de dise√±o detectado - Cache limpiado');
{% endif %}
</script>

{% else %}

{% comment %} Mensaje de configuraci√≥n requerida {% endcomment %}
{% unless block.settings.enable_widget %}
  <script>
    console.log('‚ùå WhatsApp Widget deshabilitado en la configuraci√≥n del tema');
  </script>
{% else %}
  <script>
    console.log('‚ùå WhatsApp Widget requiere configuraci√≥n del formulario');
    console.log('Faltan datos:', {
      phone_number: {{ phone_number | json }},
      message: {{ message | json }},
      button_color: {{ button_color | json }},
      position: {{ position | json }},
      icon: {{ icon | json }}
    });
  </script>
  
  {% comment %} Mostrar mensaje de ayuda solo en modo preview {% endcomment %}
  {% if request.design_mode %}
    <div style="
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #fee2e2;
      border: 2px solid #fca5a5;
      border-radius: 12px;
      padding: 16px;
      max-width: 300px;
      font-family: system-ui, sans-serif;
      font-size: 14px;
      color: #991b1b;
      z-index: 9999;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    ">
      <strong>‚ö†Ô∏è WhatsApp Widget</strong><br>
      <span style="font-size: 12px;">
        Configura el widget desde la app antes de usarlo.
        <br><br>
        <strong>Datos faltantes:</strong><br>
        {% unless phone_number %}‚ùå Tel√©fono<br>{% endunless %}
        {% unless message %}‚ùå Mensaje<br>{% endunless %}
        {% unless button_color %}‚ùå Color<br>{% endunless %}
        {% unless position %}‚ùå Posici√≥n<br>{% endunless %}
        {% unless icon %}‚ùå Icono<br>{% endunless %}
      </span>
    </div>
  {% endif %}
{% endunless %}

{% endif %}

{% schema %}
{
  "name": "WhatsApp Widget",
  "target": "body",
  "settings": [
    {
      "type": "header",
      "content": "üì± Configuraci√≥n Principal"
    },
    {
      "type": "checkbox",
      "id": "enable_widget",
      "label": "Activar Widget de WhatsApp",
      "default": true,
      "info": "Habilita o deshabilita el widget en toda la tienda"
    },
    {
      "type": "paragraph",
      "content": "‚ö†Ô∏è IMPORTANTE: Debes configurar el widget desde la app primero. Todos los datos (tel√©fono, mensaje, color, posici√≥n, icono) vienen √∫nicamente del formulario de configuraci√≥n de la app."
    },
    {
      "type": "header",
      "content": "üé® Personalizaci√≥n Visual"
    },
    {
      "type": "checkbox",
      "id": "show_text",
      "label": "Mostrar texto 'WhatsApp'",
      "default": true
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Texto del bot√≥n",
      "default": "WhatsApp",
      "info": "Solo se muestra si 'Mostrar texto' est√° activado"
    },
    {
      "type": "range",
      "id": "font_size",
      "min": 10,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Tama√±o de fuente",
      "default": 14
    },
    {
      "type": "range",
      "id": "border_radius",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Radio de borde",
      "default": 50,
      "info": "0 = cuadrado, 50 = redondeado"
    },
    {
      "type": "range",
      "id": "opacity",
      "min": 50,
      "max": 100,
      "step": 5,
      "unit": "%",
      "label": "Opacidad",
      "default": 100
    },
    {
      "type": "header",
      "content": "‚ú® Efectos y Animaciones"
    },
    {
      "type": "range",
      "id": "hover_scale",
      "min": 100,
      "max": 150,
      "step": 5,
      "unit": "%",
      "label": "Escala al hacer hover",
      "default": 110,
      "info": "100% = sin efecto, 150% = m√°ximo zoom"
    },
    {
      "type": "checkbox",
      "id": "entrance_animation",
      "label": "Activar animaci√≥n de entrada",
      "default": false
    },
    {
      "type": "range",
      "id": "entrance_delay",
      "min": 0,
      "max": 5000,
      "step": 500,
      "unit": "ms",
      "label": "Retraso de animaci√≥n",
      "default": 1000,
      "info": "Solo aplica si la animaci√≥n est√° activada"
    },
    {
      "type": "header",
      "content": "üîó Comportamiento"
    },
    {
      "type": "checkbox",
      "id": "open_in_new_tab",
      "label": "Abrir WhatsApp en nueva pesta√±a",
      "default": true,
      "info": "Si est√° desactivado, redirige en la misma pesta√±a"
    }
  ]
}
{% endschema %}